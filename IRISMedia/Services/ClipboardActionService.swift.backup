import Foundation
import AppKit
import UniformTypeIdentifiers

/// Service for clipboard operations and file export functionality
public class ClipboardActionService {

    public enum ClipboardFormat {
        case plainText
        case markdown
        case code
    }

    public init() {}

    /// Copies content to clipboard with specified format
    /// - Parameters:
    ///   - content: The content to copy
    ///   - format: The format for copying
    public func copyToClipboard(_ content: String, format: ClipboardFormat = .plainText) {
        let pasteboard = NSPasteboard.general
        pasteboard.clearContents()

        switch format {
        case .plainText, .markdown, .code:
            pasteboard.setString(content, forType: .string)
        }
    }


    /// Exports content to a file with save dialog
    /// - Parameters:
    ///   - content: Content to export
    ///   - suggestedName: Suggested filename (without extension)
    ///   - type: File type/extension
    /// - Returns: Success status
    @MainActor
    public func exportToFile(content: String, suggestedName: String, fileExtension: String) async throws -> Bool {
        let panel = NSSavePanel()
        panel.nameFieldStringValue = "\(suggestedName).\(fileExtension)"
        if let utType = UTType(filenameExtension: fileExtension, conformingTo: .text) {
            panel.allowedContentTypes = [utType]
        } else {
            panel.allowedContentTypes = [.text]
        }

        if panel.runModal() == .OK, let url = panel.url {
            try content.write(to: url, atomically: true, encoding: .utf8)
            return true
        }

        return false
    }


    /// Convenience method to copy code block content
    public func copyCodeBlock(language: String, code: String) {
        copyToClipboard(code, format: .code)
    }

    /// Convenience method to copy option content
    public func copyOptionContent(_ content: String) {
        copyToClipboard(content, format: .plainText)
    }
}